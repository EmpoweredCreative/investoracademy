generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ─── ENUMS ───────────────────────────────────────────────────

enum AccountMode {
  SIMULATED
  LIVE_SCHWAB
}

enum PremiumPolicy {
  CASHFLOW
  BASIS_REDUCTION
  REINVEST_ON_CLOSE
}

enum InstrumentType {
  STOCK
  OPTION
}

enum OptionAction {
  STO
  BTC
  BTO
  STC
  EXPIRE
  ASSIGN
  EXERCISE
}

enum StockAction {
  BUY
  SELL
}

enum InstanceStatus {
  OPEN
  FINALIZED
}

enum FinalizationReason {
  CLOSED
  EXPIRED
  ASSIGNED
  EXERCISED
}

enum LedgerType {
  PREMIUM_CREDIT
  PREMIUM_DEBIT
  STOCK_BUY
  STOCK_SELL
  FEE
  ADJUSTMENT
  CASH_DEPOSIT
}

enum CallPut {
  CALL
  PUT
}

enum LongShort {
  LONG
  SHORT
}

enum WheelCategory {
  CORE
  MAD_MONEY
  FREE_CAPITAL
  RISK_MGMT
}

enum ReinvestStatus {
  CREATED
  NOTIFIED
  ACKNOWLEDGED
  SNOOZED
  COMPLETED
  PARTIAL_COMPLETED
  SKIPPED
}

enum ReinvestAction {
  CONFIRM_FULL
  CONFIRM_PARTIAL
  SNOOZE
  SKIP
}

enum ImportRowStatus {
  NEW
  DUPLICATE_FILE
  DUPLICATE_EXTERNAL_REF
  DUPLICATE_FINGERPRINT
}

enum StrategyType {
  COVERED_CALL
  SHORT_PUT
  BULL_PUT_SPREAD
  BEAR_CALL_SPREAD
  BULL_CALL_SPREAD
  BEAR_PUT_SPREAD
  IRON_CONDOR
  IRON_BUTTERFLY
  SHORT_STRANGLE
  TIME_SPREAD
  LEAP_CALL
  LEAP_PUT
}

enum OutcomeRating {
  EXCELLENT
  GOOD
  NEUTRAL
  POOR
  TERRIBLE
}

enum NotificationChannel {
  EMAIL
  IN_APP
}

enum NotificationFrequency {
  INSTANT
  DAILY_DIGEST
}

// ─── MODELS ──────────────────────────────────────────────────

model User {
  id             String    @id @default(cuid())
  name           String?
  email          String    @unique
  hashedPassword String
  timezone       String    @default("America/New_York")
  digestHour     Int       @default(16)
  digestMinute   Int       @default(30)
  notifyChannel  NotificationChannel   @default(IN_APP)
  notifyFreq     NotificationFrequency @default(DAILY_DIGEST)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  accounts       Account[]
  notifications  Notification[]
}

model Account {
  id                 String        @id @default(cuid())
  userId             String
  name               String
  mode               AccountMode   @default(SIMULATED)
  defaultPolicy      PremiumPolicy?
  cashBalance        Decimal       @default(0) @db.Decimal(14, 4)
  cashflowReserve    Decimal       @default(0) @db.Decimal(14, 4)
  onboardingCompletedAt DateTime?
  notes              String?
  archivedAt         DateTime?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  user               User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  underlyings            Underlying[]
  strategyInstances      StrategyInstance[]
  ledgerEntries          LedgerEntry[]
  stockLots              StockLot[]
  reinvestSignals        ReinvestSignal[]
  wheelTargets           WealthWheelTarget[]
  wheelClassifications   WealthWheelClassification[]
  csvImports             CsvImport[]
  journalTrades          JournalTrade[]
  researchIdeas          ResearchIdea[]
  notifications          Notification[]

  @@unique([userId, name])
}

model Underlying {
  id            String        @id @default(cuid())
  accountId     String
  symbol        String
  currentPrice  Decimal?      @db.Decimal(12, 4)
  premiumPolicy PremiumPolicy?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  account       Account       @relation(fields: [accountId], references: [id], onDelete: Cascade)

  strategyInstances      StrategyInstance[]
  stockLots              StockLot[]
  reinvestSignals        ReinvestSignal[]
  wheelClassification    WealthWheelClassification?
  journalTrades          JournalTrade[]
  researchIdeas          ResearchIdea[]

  @@unique([accountId, symbol])
}

model StrategyInstance {
  id                     String              @id @default(cuid())
  accountId              String
  underlyingId           String
  instrumentType         InstrumentType
  strategyType           StrategyType?
  strategyGroupId        String?
  optionAction           OptionAction?
  callPut                CallPut?
  longShort              LongShort?
  strike                 Decimal?            @db.Decimal(12, 2)
  expiration             DateTime?
  quantity               Decimal             @db.Decimal(12, 4)
  status                 InstanceStatus      @default(OPEN)
  finalizationReason     FinalizationReason?
  finalizedAt            DateTime?
  realizedOptionProfit   Decimal?            @db.Decimal(14, 4)
  premiumPolicyOverride  PremiumPolicy?
  wheelCategoryOverride  WheelCategory?
  notes                  String?
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt

  account                Account             @relation(fields: [accountId], references: [id], onDelete: Cascade)
  underlying             Underlying          @relation(fields: [underlyingId], references: [id], onDelete: Cascade)

  ledgerEntries          LedgerEntry[]
  reinvestSignal         ReinvestSignal?
  journalTrade           JournalTrade?

  @@index([accountId, status])
  @@index([underlyingId])
}

model LedgerEntry {
  id                String         @id @default(cuid())
  accountId         String
  strategyInstanceId String?
  type              LedgerType
  amount            Decimal        @db.Decimal(14, 4)
  description       String?
  occurredAt        DateTime
  externalRef       String?
  fingerprint       String?
  csvImportId       String?
  createdAt         DateTime       @default(now())

  account           Account        @relation(fields: [accountId], references: [id], onDelete: Cascade)
  strategyInstance  StrategyInstance? @relation(fields: [strategyInstanceId], references: [id], onDelete: SetNull)
  csvImport         CsvImport?     @relation(fields: [csvImportId], references: [id], onDelete: SetNull)

  @@unique([accountId, externalRef])
  @@unique([accountId, fingerprint])
  @@index([accountId, occurredAt])
}

model StockLot {
  id               String     @id @default(cuid())
  accountId        String
  underlyingId     String
  acquiredAt       DateTime
  quantity         Decimal    @db.Decimal(12, 4)
  remaining        Decimal    @db.Decimal(12, 4)
  costBasis        Decimal    @db.Decimal(14, 4)  // Original total cost (purchase price × qty + fees)
  premiumReduction Decimal    @default(0) @db.Decimal(14, 4)  // Total premium applied to reduce cost basis
  createdAt        DateTime   @default(now())

  account       Account    @relation(fields: [accountId], references: [id], onDelete: Cascade)
  underlying    Underlying @relation(fields: [underlyingId], references: [id], onDelete: Cascade)

  @@index([accountId, underlyingId, acquiredAt])
}

model ReinvestSignal {
  id              String          @id @default(cuid())
  accountId       String
  underlyingId    String
  instanceId      String          @unique
  amount          Decimal         @db.Decimal(14, 4)
  status          ReinvestStatus  @default(CREATED)
  dueAt           DateTime
  acknowledgedAt  DateTime?
  completedAt     DateTime?
  completedAmount Decimal?        @db.Decimal(14, 4)
  notes           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  account         Account         @relation(fields: [accountId], references: [id], onDelete: Cascade)
  underlying      Underlying      @relation(fields: [underlyingId], references: [id], onDelete: Cascade)
  instance        StrategyInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([accountId, status])
}

model WealthWheelTarget {
  id           String        @id @default(cuid())
  accountId    String
  category     WheelCategory
  targetPct    Decimal       @db.Decimal(5, 2)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  account      Account       @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, category])
}

model WealthWheelClassification {
  id           String        @id @default(cuid())
  accountId    String
  underlyingId String        @unique
  category     WheelCategory
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  account      Account       @relation(fields: [accountId], references: [id], onDelete: Cascade)
  underlying   Underlying    @relation(fields: [underlyingId], references: [id], onDelete: Cascade)

  @@unique([accountId, underlyingId])
}

model CsvImport {
  id            String    @id @default(cuid())
  accountId     String
  fileName      String
  fileSha256    String
  rowCount      Int
  newCount      Int
  dupCount      Int
  committedAt   DateTime?
  createdAt     DateTime  @default(now())

  account       Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  ledgerEntries LedgerEntry[]

  @@unique([accountId, fileSha256])
}

model JournalTrade {
  id                  String         @id @default(cuid())
  accountId           String
  strategyInstanceId  String?        @unique
  underlyingId        String
  strike              Decimal?       @db.Decimal(12, 2)
  callPut             CallPut?
  longShort           LongShort?
  quantity            Decimal?       @db.Decimal(12, 4)
  entryDelta          Decimal?       @db.Decimal(6, 4)
  entryPrice          Decimal?       @db.Decimal(12, 4)
  entryDateTime       DateTime?
  targetPrice         Decimal?       @db.Decimal(12, 4)
  stopPrice           Decimal?       @db.Decimal(12, 4)
  exitPrice           Decimal?       @db.Decimal(12, 4)
  exitDateTime        DateTime?
  rewardRatio         Decimal?       @db.Decimal(8, 4)
  riskPct             Decimal?       @db.Decimal(8, 4)
  thesisNotes         String?
  outcomeRating       OutcomeRating?
  wheelCategoryOverride WheelCategory?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  account             Account          @relation(fields: [accountId], references: [id], onDelete: Cascade)
  underlying          Underlying       @relation(fields: [underlyingId], references: [id], onDelete: Cascade)
  strategyInstance    StrategyInstance? @relation(fields: [strategyInstanceId], references: [id], onDelete: SetNull)

  @@index([accountId])
}

model ResearchIdea {
  id                    String        @id @default(cuid())
  accountId             String
  underlyingId          String
  strategyType          StrategyType
  dte                   Int?
  atr                   Decimal?      @db.Decimal(10, 4)
  strikes               String?          // legacy – kept for backward compat
  deltas                String?          // legacy – kept for backward compat
  netCredit             Decimal?      @db.Decimal(12, 4)
  bpe                   Decimal?      @db.Decimal(14, 4)
  netDelta              Decimal?      @db.Decimal(10, 4)
  roi                   Decimal?      @db.Decimal(8, 4)
  roid                  Decimal?      @db.Decimal(8, 4)
  notes                 String?
  wheelCategoryOverride WheelCategory?
  convertedToJournalId  String?

  // ── Strategy-specific typed fields ───────────────────────
  price                 Decimal?      @db.Decimal(12, 4)  // Current stock price
  month                 String?                            // Expiration month label

  // Single-leg / primary short leg (CC, SP, BPS, BCS, TS)
  shortStrike           Decimal?      @db.Decimal(12, 4)
  shortDelta            Decimal?      @db.Decimal(6, 4)
  longStrike            Decimal?      @db.Decimal(12, 4)  // Protective long leg (BPS, BCS)

  // Multi-leg: call side (IC, SS)
  shortCallStrike       Decimal?      @db.Decimal(12, 4)
  shortCallDelta        Decimal?      @db.Decimal(6, 4)
  longCallStrike        Decimal?      @db.Decimal(12, 4)

  // Multi-leg: put side (IC, SS)
  shortPutStrike        Decimal?      @db.Decimal(12, 4)
  shortPutDelta         Decimal?      @db.Decimal(6, 4)
  longPutStrike         Decimal?      @db.Decimal(12, 4)

  // Short Strangle extras
  earningsDate          String?
  expectedGap           Decimal?      @db.Decimal(10, 4)
  expiration            String?

  // Time Spread extras
  spreadSubType         String?                            // Diag Call, Diag Put, Horiz Call, Horiz Put
  longStrikeExp         String?
  longStrikeDebit       Decimal?      @db.Decimal(12, 4)
  shortStrikeExp        String?
  shortStrikeCredit     Decimal?      @db.Decimal(12, 4)

  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  account               Account       @relation(fields: [accountId], references: [id], onDelete: Cascade)
  underlying            Underlying    @relation(fields: [underlyingId], references: [id], onDelete: Cascade)

  @@index([accountId, strategyType])
}

model Notification {
  id         String    @id @default(cuid())
  userId     String
  accountId  String?
  title      String
  body       String
  read       Boolean   @default(false)
  sentAt     DateTime?
  createdAt  DateTime  @default(now())

  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  account    Account?  @relation(fields: [accountId], references: [id], onDelete: SetNull)

  @@index([userId, read])
}
